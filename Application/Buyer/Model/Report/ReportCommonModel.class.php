<?phpnamespace Buyer\Model\Report;class ReportCommonModel {    public $reportDb;    public $sqlAry;    public $allowReportType = array(        "sellerSummary" => "ReportSellSummaryModel",        "sellerMedia" => "ReportSellMediaModel",        "sellerPlace" => "ReportSellPlaceModel",        "buyerSummary" => "ReportBuySummaryModel",        "operationSummary" => "ReportOperationSummaryModel",        "operationPlace" => "ReportOperationPlaceModel",        "operationPmp" => "ReportOperationPmpModel",        "operationFailure" => "ReportOperationFailureModel",    );    public $needName = array(        'sellerSummary' => 'getSellerInfo',        'sellerMedia' => 'getSellerInfo',        'sellerPlace' => 'getSellerInfo',        'buyerSummary' => 'getBuyerInfo',        'operationSummary' => 'getOperationInfo',        'operationPlace' => 'getOperationInfo',        'operationFailure' => 'getOperationFailureInfo',    );    public $pageSize = 10;    public $reportNamespace = "\\Admin\\Model\\Report\\";    public $msg = array('status' => 'ok', 'data' => array());    public $request;    public function __construct($param) {        if (isset($this->allowReportType[$param['reportType']])) {            $obj = $this->reportNamespace . $this->allowReportType[$param['reportType']];            $this->reportDb = new $obj();            if (isset($param['groupBy'])) {                $this->reportDb->groupBy = $param['groupBy'];                if ($this->reportDb->groupBy == 'reportDate') {                    unset($this->reportDb->field['sellerId']);                    if(isset($this->reportDb->field['mediaId'])) {                        unset($this->reportDb->field['mediaId']);                    }                }                if ($this->reportDb->groupBy == 'sellerId') {                    if(isset($this->reportDb->field['mediaId'])) {                        unset($this->reportDb->field['mediaId']);                    }                }                if ($this->reportDb->groupBy == 'mediaId') {                    if(isset($this->reportDb->field['placeId'])) {                        unset($this->reportDb->field['placeId']);                    }                }            }            $param['pageSize'] = isset($param['pageSize']) ? $param['pageSize'] : $this->pageSize;            $this->pageSize = $param['pageSize'];//            $param['resource']['placeId'] = [33 => 33];//            $param['resource']['mediaId'] = [1 => 1];////            $param['groupId'] = $_SESSION['buyer']['userInfo']['idPlatform'];            $this->request = $param;            $this->reportDb->setParam($param);        } else {            $this->msg['status'] = 'error';        }    }    public function getNameInfo($list) {        if (isset($this->needName[$this->request['reportType']])) {            $function = $this->needName[$this->request['reportType']];            $list = $this->$function($list);        }        return $list;    }    public function sellerSummaryList($list) {        $result = [];        $sellers = D('Seller')->getIdKeyArr();        foreach ($list as $k => $v) {            if (!isset($v['sellerid'])) {                $v['sellerid'] = '-';            }else {                $sellerId = $v['sellerid'];                $v['sellerid'] = $sellers[$sellerId]['company'];                $v['spend'] = number_format($v['spend'], 2, '.', ',');                $v['cpm'] = number_format(($v['spend'] / ($v['play'] / 1000)), 2, '.', ',');                $v['cpc'] = number_format(($v['spend'] / $v['click']), 2, '.', ',');                $v['sellerspend'] = number_format($v['sellerspend'], 2, '.', ',');                $v['sellercpm'] = number_format(($v['sellerspend'] / ($v['sellerplay'] / 1000)), 2, '.', ',');                $v['sellercpc'] = number_format(($v['sellerspend'] / $v['sellerclick']), 2, '.', ',');                $v['buyerspend'] = number_format($v['buyerspend'], 2, '.', ',');            }            $result[$k] = $v;        }        return $result;    }    public function getSellerInfo($list) {        $result = [];        $sellers = D('Seller')->getIdKeyArr();        $medias = D('Media')->getIdKeyArr();        $places = D('place')->getIdKeyArr();        foreach ($list as $k => $v) {            if (!isset($v['sellerid'])) {                $v['sellerid'] = '-';            }else {                $sellerId = $v['sellerid'];                $v['sellerid'] = $sellers[$sellerId]['company'];            }            if (!isset($v['mediaid'])) {                $v['mediaid'] = '-';            }else {                $mediaId = $v['mediaid'];                $v['mediaid'] = $medias[$mediaId]['name'];            }            if (!isset($v['placeid'])) {                $v['placeid'] = '-';            }else {                $placeId = $v['placeid'];                $v['placeid'] = $places[$placeId]['name'];            }            $v['spend'] = number_format($v['spend'], 2, '.', ',');            $v['cpm'] = number_format(($v['spend'] / ($v['play'] / 1000)), 2, '.', ',');            $v['cpc'] = number_format(($v['spend'] / $v['click']), 2, '.', ',');            $v['sellerspend'] = number_format($v['sellerspend'], 2, '.', ',');            $v['sellercpm'] = number_format(($v['sellerspend'] / ($v['sellerplay'] / 1000)), 2, '.', ',');            $v['sellercpc'] = number_format(($v['sellerspend'] / $v['sellerclick']), 2, '.', ',');            $v['buyerspend'] = number_format($v['buyerspend'], 2, '.', ',');            $result[$k] = $v;        }        return $result;    }    public function getBuyerInfo($list) {        $result = [];        $buyers = D('Buyer')->getIdKeyArr();        foreach ($list as $k => $v) {            if (!isset($v['buyerid'])) {                $v['buyerid'] = '-';            }else {                $buyerId = $v['buyerid'];                $v['buyerid'] = $buyers[$buyerId]['company'];            }            $v['spend'] = number_format($v['spend'], 2, '.', ',');            $v['cpm'] = number_format(($v['spend'] / ($v['play'] / 1000)), 2, '.', ',');            $v['cpc'] = number_format(($v['spend'] / $v['click']), 2, '.', ',');            $v['sellerspend'] = number_format($v['sellerspend'], 2, '.', ',');            $v['sellercpm'] = number_format(($v['sellerspend'] / ($v['sellerplay'] / 1000)), 2, '.', ',');            $v['sellercpc'] = number_format(($v['sellerspend'] / $v['sellerclick']), 2, '.', ',');            $v['buyerspend'] = number_format($v['buyerspend'], 2, '.', ',');            $result[$k] = $v;        }        return $result;    }    public function getOperationInfo($list) {        $result = [];        $sellers = D('Seller')->getIdKeyArr();        $buyers = D('Buyer')->getIdKeyArr();        $medias = D('Media')->getIdKeyArr();        $places = D('place')->getIdKeyArr();        foreach ($list as $k => $v) {            if (!isset($v['sellerid'])) {                $v['sellerid'] = '-';            }else {                $sellerId = $v['sellerid'];                $v['sellerid'] = $sellers[$sellerId]['company'];            }            if (!isset($v['buyerid'])) {                $v['buyerid'] = '-';            }else {                $buyerId = $v['buyerid'];                $v['buyerid'] = $buyers[$buyerId]['company'];            }            if (!isset($v['mediaid'])) {                $v['mediaid'] = '-';            }else {                $mediaId = $v['mediaid'];                $v['mediaid'] = $medias[$mediaId]['name'];            }            if (!isset($v['placeid'])) {                $v['placeid'] = '-';            }else {                $placeId = $v['placeid'];                $v['placeid'] = $places[$placeId]['name'];            }            $v['spend'] = number_format($v['spend'], 2, '.', ',');            $v['cpm'] = number_format(($v['spend'] / ($v['play'] / 1000)), 2, '.', ',');            $v['cpc'] = number_format(($v['spend'] / $v['click']), 2, '.', ',');            $v['sellerspend'] = number_format($v['sellerspend'], 2, '.', ',');            $v['sellercpm'] = number_format(($v['sellerspend'] / ($v['sellerplay'] / 1000)), 2, '.', ',');            $v['sellercpc'] = number_format(($v['sellerspend'] / $v['sellerclick']), 2, '.', ',');            $v['buyerspend'] = number_format($v['buyerspend'], 2, '.', ',');            $result[$k] = $v;        }        return $result;    }    public function getOperationFailureInfo($list) {        $result = [];        $sellers = D('Seller')->getIdKeyArr();        $buyers = D('Buyer')->getIdKeyArr();        $medias = D('Media')->getIdKeyArr();        $places = D('place')->getIdKeyArr();        foreach ($list as $k => $v) {            if (!isset($v['sellerid'])) {                $v['sellerid'] = '-';            }else {                $sellerId = $v['sellerid'];                $v['sellerid'] = $sellers[$sellerId]['company'];            }            if (!isset($v['buyerid'])) {                $v['buyerid'] = '-';            }else {                $buyerId = $v['buyerid'];                $v['buyerid'] = $buyers[$buyerId]['company'];            }            if (!isset($v['mediaid'])) {                $v['mediaid'] = '-';            }else {                $mediaId = $v['mediaid'];                $v['mediaid'] = $medias[$mediaId]['name'];            }            if (!isset($v['placeid'])) {                $v['placeid'] = '-';            }else {                $placeId = $v['placeid'];                $v['placeid'] = $places[$placeId]['name'];            }            $result[$k] = $v;        }        return $result;    }    public function getData() {        if ($this->msg['status'] == 'ok') {            $this->sqlAry = $this->reportDb->getSql();            $totalNum = $this->reportDb->query($this->sqlAry['totalNumSql']);            if (count($totalNum) > 0) {                $info = $this->reportDb->query($this->sqlAry['sql']);                $totalInfo = $this->reportDb->query($this->sqlAry['totalSql']);                $list = array();                foreach ($info as $key => $item) {                    foreach ($item as $field => $value) {                        if ($value == null || $value == 0) {                            $list[$key][$field] = 0;                        } else {                            $list[$key][$field] = $value;                        }                    }                }                foreach ($totalInfo as $key => $item) {                    foreach ($item as $field => $value) {                        if ($value == null || $value == 0) {                            $totalInfo[$key][$field] = 0;                        } else {                            $totalInfo[$key][$field] = $value;                        }                    }                }                unset($info);                $this->msg['maxPage'] = ceil(count($totalNum) / $this->pageSize);                $this->msg['totalNum'] = count($totalNum);                $this->msg['data']['list'] = $this->getNameInfo($list);                $this->msg['data']['total'] = $totalInfo[0];            } else {                $this->msg['status'] = 'error';            }            $this->msg['sql'] = $this->sqlAry;            return $this->msg;        }    }}